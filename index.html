<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>磚家計算 - 檔案管理平台</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- 這裡保留您原本的 CSS 設定 (為了版面整潔，稍微壓縮了) --- */
        :root { --bg-color: #f9fbfd; --header-height: 64px; --search-bg: #f1f3f4; --text-primary: #202124; --text-secondary: #5f6368; --border-color: #dadce0; --hover-bg: rgba(60,64,67,0.08); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Google Sans', Roboto, Arial, sans-serif; }
        body { background-color: white; color: var(--text-primary); }
        header { display: flex; align-items: center; justify-content: space-between; height: var(--header-height); padding: 8px 16px; position: sticky; top: 0; background: white; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; min-width: 200px; }
        .logo-area { display: flex; align-items: center; gap: 8px; font-size: 22px; color: var(--text-secondary); font-weight: 400; }
        .logo-area img { height: 32px; width: auto; }
        .header-center { flex: 1; max-width: 720px; padding: 0 20px; position: relative; }
        .search-bar { background: var(--search-bg); border-radius: 8px; height: 48px; display: flex; align-items: center; padding: 0 16px; transition: 0.3s; position: relative; z-index: 102; }
        .search-bar.active { background: white; border-bottom-left-radius: 0; border-bottom-right-radius: 0; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15); }
        .search-bar input { border: none; background: transparent; flex: 1; padding: 0 10px; font-size: 16px; outline: none; color: var(--text-primary); }
        .header-right { display: flex; align-items: center; gap: 16px; min-width: 100px; justify-content: flex-end; }
        .icon-btn { padding: 12px; border-radius: 50%; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; user-select: none; position: relative; }
        .icon-btn:hover { background-color: var(--hover-bg); }
        main { display: flex; flex-direction: column; }
        .template-section { background-color: var(--bg-color); padding: 20px 0; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-size: 16px; color: #202124; }
        .template-grid { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; }
        .template-card { display: flex; flex-direction: column; cursor: pointer; width: 136px; flex-shrink: 0; }
        .template-preview { height: 176px; background-color: white; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px; transition: 0.2s; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .template-card:hover .template-preview { border-color: #4285F4; }
        .new-doc-btn { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .plus-icon { font-size: 48px; background: linear-gradient(to bottom right, #4285F4 0%, #EA4335 30%, #FBBC04 60%, #34A853 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .template-title { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .recent-section { padding: 20px 0; background-color: white; min-height: 500px; }
        .filter-controls { display: flex; align-items: center; gap: 5px; position: relative; }
        .docs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; }
        .doc-card { border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; transition: 0.2s; background: white; }
        .doc-card:hover { border-color: #4285F4; }
        .doc-preview { height: 220px; border-bottom: 1px solid var(--border-color); background-color: white; display: flex; justify-content: center; padding: 10px; overflow: hidden; }
        .mock-doc-content { width: 80%; height: 100%; display: flex; flex-direction: column; gap: 8px; opacity: 0.3; }
        .line { height: 8px; background: #999; border-radius: 2px; }
        .line.short { width: 50%; }
        .line.long { width: 100%; }
        .doc-info { padding: 12px; }
        .doc-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .doc-meta { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
        .doc-date { flex: 1; }
        
        /* 列表模式 */
        .list-header { display: none; padding: 0 16px; margin-bottom: 8px; margin-top: 10px; font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .docs-list-container { display: flex; flex-direction: column; }
        .list-row { display: flex; align-items: center; padding: 10px 16px; border-radius: 24px; cursor: pointer; transition: background 0.1s; border-bottom: 1px solid transparent; }
        .list-row:hover { background-color: #f0f4f9; }
        .list-icon-img { width: 20px; height: auto; margin-right: 16px; }
        .doc-icon-small-img { width: 16px; height: auto; opacity: 0.7; }
        .list-title { flex: 1; font-size: 14px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 20px; }
        .list-date { width: 150px; font-size: 13px; color: var(--text-secondary); text-align: left; }

        /* Modal 樣式 */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal h3 { margin-bottom: 15px; }
        textarea { width: 100%; height: 200px; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }
        .modal-btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background-color: #4285F4; color: white; }
        .btn-secondary { background-color: #e0e0e0; color: #333; margin-right: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <span class="material-icons icon-btn">menu</span>
            <div class="logo-area">
                <img src="logo.png" alt="Logo" onerror="this.style.display='none'"> <span>磚家計算</span>
            </div>
        </div>
        <div class="header-center" id="searchWrapper">
            <div class="search-bar" id="searchBar">
                <span class="material-icons icon-btn" style="padding:0; margin-right:8px;">search</span>
                <input type="text" placeholder="搜尋檔案" id="searchInput" autocomplete="off">
            </div>
        </div>
        <div class="header-right">
            <div style="width: 32px; height: 32px; background:purple; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center;">U</div>
        </div>
    </header>

    <main>
        <section class="template-section">
            <div class="container">
                <div class="section-header">
                    <span><strong>新增空白檔案</strong></span>
                </div>
                <div class="template-grid">
                    <div class="template-card" onclick="createNewFile()">
                        <div class="template-preview">
                            <div class="new-doc-btn">
                                <span class="material-icons plus-icon">add</span>
                            </div>
                        </div>
                        <div class="template-title">空白專案</div>
                    </div>

                    <div class="template-card" onclick="openImportModal()">
                        <div class="template-preview">
                            <div class="new-doc-btn">
                                <span class="material-icons plus-icon">file_upload</span>
                            </div>
                        </div>
                        <div class="template-title">匯入 Object</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="recent-section">
            <div class="container">
                <div class="section-header">
                    <span><strong>我的檔案</strong></span>
                    <div class="filter-controls">
                        <span class="material-icons icon-btn" id="viewToggleBtn" title="List view">list</span>
                        <span class="material-icons icon-btn" onclick="refreshDocs()" title="Refresh">refresh</span>
                    </div>
                </div>

                <div class="list-header" id="listHeader">
                    <div style="flex:1; padding-left: 36px;">檔案名稱</div>
                    <div style="width: 150px;">最後修改時間</div>
                    <div style="width: 40px;"></div>
                </div>

                <div id="docsContainer" class="docs-grid"></div>
            </div>
        </section>
    </main>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>匯入檔案資料 (JSON Object)</h3>
            <textarea id="importTextarea" placeholder='請在此貼上完整的 JSON Object...'></textarea>
            <div style="text-align: right;">
                <button class="modal-btn btn-secondary" onclick="closeImportModal()">取消</button>
                <button class="modal-btn btn-primary" onclick="executeImport()">匯入</button>
            </div>
        </div>
    </div>

    <script>
        // --- 全域變數與初始化 ---
        const LS_KEY = 'landAnalysisFiles';
        let documents = [];
        let isListView = false;
        const docsContainer = document.getElementById('docsContainer');
        const listHeader = document.getElementById('listHeader');
        const viewToggleBtn = document.getElementById('viewToggleBtn');
        const searchInput = document.getElementById('searchInput');

        // 預設的空白檔案模板
        const DEFAULT_TEMPLATE = {
            '檔案名稱' : '未命名專案',
            '基本資料' : { '案名' : '', '使用分區' : '' },
            '基地條件' : { '基地面積' : 0, '路寬' : 0 },
            '法規參數' : { '建蔽率' : 0, '容積率' : 0, '容移獎勵' : 0 },
            '建築規劃' : { '銷售係數' : 1.62, '屋突面積' : 0, '地下室面積' : 0, '樓層數' : 0 }
        };

        // --- 核心功能：讀取與儲存 ---

        function loadDocuments() {
            const raw = localStorage.getItem(LS_KEY);
            if (raw) {
                documents = JSON.parse(raw);
            } else {
                documents = [];
            }
            renderDocs();
        }

        function saveDocuments() {
            localStorage.setItem(LS_KEY, JSON.stringify(documents));
            renderDocs();
        }

        // 產生 UUID
        function generateUUID() {
            return 'doc_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        }

        // 取得當前時間字串
        function getCurrentDateStr() {
            const d = new Date();
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // 檔名防重複邏輯
        function getUniqueFilename(baseName) {
            let name = baseName;
            let counter = 1;
            // 檢查 documents 陣列中是否有同名
            while (documents.some(doc => doc.filename === name)) {
                name = `${baseName} (${counter++})`;
            }
            return name;
        }

        // --- 功能：新增檔案 ---
        function createNewFile() {
            const uniqueName = getUniqueFilename('未命名專案');
            const newDoc = {
                id: generateUUID(),
                filename: uniqueName,
                lastModified: getCurrentDateStr(),
                data: JSON.parse(JSON.stringify(DEFAULT_TEMPLATE)) // 深拷貝
            };
            
            // 同步內部的檔案名稱
            newDoc.data['檔案名稱'] = uniqueName;

            documents.unshift(newDoc); // 加到最前面
            saveDocuments();
            openAnalysis(newDoc.id);
        }

        // --- 功能：匯入檔案 ---
        function openImportModal() {
            document.getElementById('importTextarea').value = '';
            document.getElementById('importModal').style.display = 'block';
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function executeImport() {
            const jsonStr = document.getElementById('importTextarea').value;
            try {
                const parsedData = JSON.parse(jsonStr);
                
                // 基本驗證：是否有必要的欄位
                if (!parsedData['檔案名稱'] || !parsedData['基本資料']) {
                    throw new Error("格式錯誤：缺少必要欄位");
                }

                const baseName = parsedData['檔案名稱'];
                const uniqueName = getUniqueFilename(baseName);
                
                // 如果檔名有變更，要同步更新內部的名稱
                if (uniqueName !== baseName) {
                    parsedData['檔案名稱'] = uniqueName;
                }

                const newDoc = {
                    id: generateUUID(),
                    filename: uniqueName,
                    lastModified: getCurrentDateStr(),
                    data: parsedData
                };

                documents.unshift(newDoc);
                saveDocuments();
                closeImportModal();
                alert(`匯入成功！已儲存為：${uniqueName}`);

            } catch (e) {
                alert("匯入失敗：JSON 格式錯誤或內容不完整。\n" + e.message);
            }
        }

        // --- 功能：開啟分析頁面 ---
        function openAnalysis(id) {
            // 開啟新分頁，帶上 ID
            window.open(`analysis.html?id=${id}`, '_blank');
        }

        // --- UI 渲染 ---
        function renderDocs() {
            docsContainer.innerHTML = '';
            docsContainer.className = isListView ? 'docs-list-container' : 'docs-grid';
            listHeader.style.display = isListView ? 'flex' : 'none';

            const filterText = searchInput.value.toLowerCase();
            const filtered = documents.filter(doc => doc.filename.toLowerCase().includes(filterText));

            filtered.forEach(doc => {
                if (isListView) {
                    const row = document.createElement('div');
                    row.className = 'list-row';
                    row.onclick = () => openAnalysis(doc.id);
                    row.innerHTML = `
                        <img src="logo.png" class="list-icon-img" alt="icon" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzQyODVGNCIgZD0iTTE0IDJINkMyLjg5IDIgMiAyLjg5IDIgNHYxNmMwIDEuMTEuODkgMiAyIDJoMTJjMS4xMSAwIDItLjg5IDItMlY4bC02LTZ6bTIgMTZINnYtMmgydjJ6bTAtNGgtMnYtMmgydjJ6bTAtNGgtMnYtMmgydjJ6Ii8+PC9zdmc+'">
                        <div class="list-title">${doc.filename}</div>
                        <div class="list-date">${doc.lastModified}</div>
                        <span class="material-icons icon-btn" onclick="deleteDoc(event, '${doc.id}')" title="刪除">delete</span>
                    `;
                    docsContainer.appendChild(row);
                } else {
                    const card = document.createElement('div');
                    card.className = 'doc-card';
                    card.onclick = () => openAnalysis(doc.id);
                    card.innerHTML = `
                        <div class="doc-preview">
                            <div class="mock-doc-content">
                                <div class="line long"></div><div class="line long"></div><div class="line short"></div>
                                <div class="line long" style="margin-top: 10px"></div><div class="line long"></div>
                            </div>
                        </div>
                        <div class="doc-info">
                            <div class="doc-title">${doc.filename}</div>
                            <div class="doc-meta">
                                <span class="doc-date">${doc.lastModified}</span>
                                <span class="material-icons icon-btn" onclick="deleteDoc(event, '${doc.id}')" style="padding:2px; font-size:18px;" title="刪除">delete</span>
                            </div>
                        </div>
                    `;
                    docsContainer.appendChild(card);
                }
            });
        }

        // 刪除檔案
        function deleteDoc(e, id) {
            e.stopPropagation(); // 防止觸發開啟檔案
            if (confirm('確定要刪除此檔案嗎？')) {
                documents = documents.filter(doc => doc.id !== id);
                saveDocuments();
            }
        }

        // 重新整理 (當從分析頁回來時可能有檔名變更)
        function refreshDocs() {
            loadDocuments();
        }

        // 事件監聽
        viewToggleBtn.addEventListener('click', () => {
            isListView = !isListView;
            viewToggleBtn.textContent = isListView ? 'grid_view' : 'list';
            renderDocs();
        });

        searchInput.addEventListener('input', renderDocs);
        
        // 監聽 Visibility Change (當使用者從分析頁切換回來時，自動更新列表)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                loadDocuments();
            }
        });

        // 初始載入
        loadDocuments();

    </script>
</body>
</html>